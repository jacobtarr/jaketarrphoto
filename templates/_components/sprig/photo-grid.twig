{# Import the radio filter #}
{% import '_components/molecules/radio-filter.twig' as radioFilter %}

{# Import the checkbox filter #}
{% import '_components/molecules/checkbox-filter.twig' as checkboxFilter %}

{# Retrieve and set default filter values #}
{% set offset = offset ?? 0 %}
{% set limit = limit ?? 9 %}
{% set nextOffset = offset + limit %}
{% set state = (reset is defined) ? '' : (state ?? '') %}
{% set genre = genre is iterable ? genre : (genre ? [genre] : []) %}
{% set season = season is iterable ? season : (season ? [season] : []) %}
{% set selectedFilterCount = (state ? 1 : 0) + season|length + genre|length %}
{% set sort = (reset is defined) ? '' : (sort ?? '') %}

{# Fetch the available categories for filters #}
{% set states = craft.categories.group('state').all() %}
{% set checkboxFilters = [
  { handle: 'season', selected: season },
  { handle: 'genre', selected: genre }
] %}

<div
  class="c-portfolio md:space-y-12"
  x-data="{
    filterOpen: $persist(false).as('portfolioFilterOpen'),
    toggleBodyScroll(value = this.filterOpen) {
      const isMobile = window.matchMedia('(max-width: 767px)').matches;
      if (isMobile) {
        document.body.classList.toggle('overflow-hidden', value);
      } else {
        document.body.classList.remove('overflow-hidden');
      }
    }
  }"
  x-init="
    toggleBodyScroll(filterOpen);
    $watch('filterOpen', value => toggleBodyScroll(value));
    window.addEventListener('resize', () => toggleBodyScroll());

    // Restore scroll after sort/reset
    const stored = sessionStorage.getItem('sortScrollTop') || sessionStorage.getItem('resetScrollTop');
    if (stored !== null) {
      window.scrollTo({ top: parseInt(stored), behavior: 'auto' });
      sessionStorage.removeItem('sortScrollTop');
      sessionStorage.removeItem('resetScrollTop');
    }
  "
>
  {% set portfolioHeroImageData = {
    '' : { image: '/dist/images/portfolio-hero/base.jpg', heading: '' },
    'arizona': { image: '/dist/images/portfolio-hero/arizona.jpg', heading: 'Arizona' },
    'utah': { image: '/dist/images/portfolio-hero/utah.jpg', heading: 'Utah' },
    'colorado': { image: '/dist/images/portfolio-hero/colorado.jpg', heading: 'Colorado' },
    'new-mexico': { image: '/dist/images/portfolio-hero/new-mexico.jpg', heading: 'New Mexico' },
    'nevada': { image: '/dist/images/portfolio-hero/nevada.jpg', heading: 'Nevada' }
  } %}

  {% set portfolioHero = portfolioHeroImageData[state] ?? portfolioHeroImageData[''] %}

  {% include '_components/molecules/hero.twig' with {
    hero: {
      image: portfolioHero.image,
      heading: 'Portfolio',
      secondary_heading: portfolioHero.heading
    }
  } %}

  <div class="container space-y-5">
    <div class="c-filter-nav">
      <div class="hidden md:flex items-center gap-x-5 relative">
        <h4 class="text-2xl font-semibold">Filters</h4>
        {% if state or season|length > 0 or genre|length > 0 %}
          <div x-data>
            {% include '_components/atoms/button.twig' with {
              button: {
                tag: 'button',
                classes: 'c-reset-button',
                text: 'Reset Filters',
                icon: 'close',
                attrs: {
                  sprig: true,
                  's-preserve': true,
                  's-val:reset': '1',
                  's-val:offset': '0',
                  's-val:limit': limit,
                  'x-on:click': "
                    sessionStorage.setItem('resetScrollTop', window.scrollY);
                    document.querySelectorAll('#filters-form input').forEach(input => {
                      if (input.type === 'checkbox') input.checked = false;
                      if (input.type === 'radio') input.checked = input.value === '';
                    });
                    const url = new URL(window.location);
                    url.search = '';
                    window.history.replaceState({}, '', url);
                    document.querySelector('#filters-form').requestSubmit();
                  "
                }
              }
            } %}
          </div>
        {% endif %}
      </div>
      <div class="c-filter-nav__col c-filter-nav__mobile-buttons">
        {% include '_components/atoms/button.twig' with {
          button: {
            text: 'Filters' ~ (selectedFilterCount > 0 ? ' (' ~ selectedFilterCount ~ ')' : ''),
            icon: 'filter',
            tag: 'button',
            classes: 'justify-between',
            attrs: {
              '@click': 'filterOpen = true'
            }
          }
        } %}
      </div>

      <div class="c-filter-nav__col c-filter-nav__sort-by" x-data="{ sort: '{{ sort }}' }">
        <h4 class="text-2xl font-semibold hidden md:block">Sort by</h4>
        <div class="c-dropdown-container w-full md:w-auto" x-data x-init="
          const stored = sessionStorage.getItem('sortScrollTop');
          if (stored !== null) {
            window.scrollTo({ top: parseInt(stored), behavior: 'auto' });
            sessionStorage.removeItem('sortScrollTop');
          }
        ">
          {% include '_components/atoms/dropdown.twig' with {
            dropdown: {
              name: 'sort',
              selected: sort,
              prepend_text: 'Sort by:',
              options: [
                { value: '', label: 'Newest First' },
                { value: 'oldest', label: 'Oldest First' },
                { value: 'titleAsc', label: 'Title (A–Z)' },
                { value: 'titleDesc', label: 'Title (Z–A)' }
              ],
              classes: 'c-dropdown--sort-by',
              icon: 'sort-by',
              attrs: {
              'x-model': 'sort',
              'x-on:change': "
                const scrollTop = window.scrollY;
                sessionStorage.setItem('sortScrollTop', scrollTop);
                const url = new URL(window.location.href);
                url.searchParams.set('sort', sort);
                document.querySelector('#filters-form').requestSubmit();
                "
              }
            }
          } %}
        </div>
      </div>
      {# end .c-portfolio__sort-by-section #}
    </div>
    <div class="c-portfolio-grid js-photo-grid grid md:grid-cols-4 gap-5">
      <div
  x-data="filterScroll()"
  x-init="restoreScroll()"
  @sprig:success.window="restoreScroll()"
>
      {# start .c-filter-sidebar #}
      <div
        x-show="filterOpen"
        x-transition:enter="transition-opacity ease-in duration-50"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-in duration-175 delay-75"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black/90 z-[90] md:hidden"
        @click="filterOpen = false"
      >
      </div>
      <div
        x-show="filterOpen"
        x-transition:enter="transition transform ease-in duration-175 delay-50"
        x-transition:enter-start="-translate-x-full"
        x-transition:enter-end="translate-x-0"
        x-transition:leave="transition transform ease-in duration-175"
        x-transition:leave-start="translate-x-0"
        x-transition:leave-end="-translate-x-full"
        class="c-filter-sidebar"
        @click.outside="filterOpen = false"
      >
        <div class="c-filter-box-container" @click.stop>
          <div class="c-filter-box">
            <div class="c-filter-box__mobile-nav">
              <h4 class="text-2xl font-semibold">Filters</h4>
              {% if state or season|length > 0 or genre|length > 0 %}
                <div x-data>
                  {% include '_components/atoms/button.twig' with {
                    button: {
                      tag: 'button',
                      classes: 'c-reset-button',
                      text: 'Reset Filters',
                      icon: 'close',
                      attrs: {
                        sprig: true,
                        's-val:reset': '1',
                        's-val:offset': '0',
                        's-val:limit': limit,
                        'x-on:click': "
                          sessionStorage.setItem('resetScrollTop', window.scrollY);
                          document.querySelectorAll('#filters-form input').forEach(input => {
                            if (input.type === 'checkbox') input.checked = false;
                            if (input.type === 'radio') input.checked = input.value === '';
                          });
                          const url = new URL(window.location);
                          url.search = '';
                          window.history.replaceState({}, '', url);
                          document.querySelector('#filters-form').requestSubmit();
                        "
                      }
                    }
                  } %}
                </div>
              {% endif %}
            </div>
            <div
            x-data="{
              visible: false,
              saveScroll() {
                sessionStorage.setItem('filterScrollTop', this.$refs.scroll.scrollTop);
              },
              restoreScroll() {
                this.$nextTick(() => {
                  const scrollTop = sessionStorage.getItem('filterScrollTop');
                  if (this.$refs.scroll && scrollTop) {
                    this.$refs.scroll.scrollTop = parseInt(scrollTop);
                  }
                });
              }
            }"
            x-init="if (window.innerWidth < 768) { setTimeout(() => { visible = true; restoreScroll(); }, 200); } else { visible = true; }"
            @sprig:success.window="if (window.innerWidth < 768) { setTimeout(() => { visible = true; restoreScroll(); }, 200); } else { visible = true; }"
            class="c-filter-sections-wrapper"
          >
            {# start #filters-form #}
            <form
              sprig
              id="filters-form"
              @scroll.debounce.150ms="saveScroll()"
              x-ref="scroll"
              s-preserve
              class="c-filter-sections-container"
            >
              <div
                x-show="visible"
                x-cloak
                x-transition:enter="transition-opacity duration-1000 ease-in-out"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition-opacity duration-500 ease-in"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="c-filter-sections"
              >
                {% set allStates = [{ title: 'All States', slug: '' }] | merge(states) %}
                
                {# Prepare s-val extras (exclude checkbox filters to avoid duplication) #}
                {% set checkboxFilterHandles = checkboxFilters|map(f => f.handle) %}
                {% set extraVals = {
                  'season': season,
                  'genre': genre,
                  'offset': offset,
                  'limit': limit,
                  'sort': sort
                }|filter((val, key) => key not in checkboxFilterHandles) %}
                {{ radioFilter.renderFilter(
                  'States',
                  allStates,
                  state,
                  'state',    
                  limit,
                  sort,
                  extraVals
                ) }}
                {% for filter in checkboxFilters %}
                  {% set categories = craft.categories.group(filter.handle).all() %}
                  {% set extraAttrs = {
                    's-val:limit': limit,
                    's-val:sort': sort,
                    'formSelector': '#filters-form'
                  } %}

                  {% if filter.handle == 'season' %}
                    {% set extraAttrs = extraAttrs
                      | merge(season|map(s => {'s-val:season[]': s})|reduce((a, b) => a|merge(b), {})) %}
                  {% elseif filter.handle == 'genre' %}
                    {% set extraAttrs = extraAttrs
                      | merge(genre|map(g => {'s-val:genre[]': g})|reduce((a, b) => a|merge(b), {})) %}
                  {% endif %}

                  {{ checkboxFilter.renderFilter(
                    filter.handle|capitalize ~ 's',
                    categories,
                    filter.selected,
                    filter.handle,
                    extraAttrs
                  ) }}
                {% endfor %}
                </div>
              </div>
            </form>{# end #filters-form #}
          </div>
        </div>
      </div>
      {# end .c-filter-sidebar #}
      </div>
      
      <div class="c-portfolio__results col-span-1 md:col-span-3" x-data='{"sort": {{ sort|default('')|json_encode|raw }} }'>
        {% set query = craft.entries().section('photos') %}
        {% if sort == 'oldest' %}
          {% set query = query.orderBy('postDate ASC') %}
        {% elseif sort == 'titleAsc' %}
          {% set query = query.orderBy('title ASC') %}
        {% elseif sort == 'titleDesc' %}
          {% set query = query.orderBy('title DESC') %}
        {% else %}
          {% set query = query.orderBy('postDate DESC') %}
        {% endif %}
        
        {% set relatedConditions = [] %}

        {# Handle radio filter for state #}
        {% if state %}
          {% set category = craft.categories.slug(state).one() %}
          {% if category %}
            {% set relatedConditions = relatedConditions|merge([
              { targetElement: category, field: 'state' }
            ]) %}
          {% endif %}
        {% endif %}

        {# Handle checkbox filters #}
        {% for filter in checkboxFilters %}
          {% set selectedSlugs = filter.selected %}
          {% if selectedSlugs|length %}
            {% set cats = craft.categories().group(filter.handle).slug(selectedSlugs).all() %}
            {% if cats|length %}
              {% set relatedConditions = relatedConditions|merge([
                {
                  field: filter.handle,
                  targetElement: cats
                }
              ]) %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if relatedConditions|length %}
          {% set query = query.relatedTo(['and']|merge(relatedConditions)) %}
        {% endif %}

        {% set total = query.count() %}
        {% set entries = query.offset(offset).limit(limit).all() %}
        {% set isLastPage = nextOffset >= total %}

        {% if entries|length %}
          <div id="photo-grid" class="c-portfolio-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5">
            {% for photoEntry in entries %}
              <div class="col-span-1 c-photo-block-container">
                {% include '_components/molecules/photo-block.twig' with {
                  "photo": {
                    "image": photoEntry.featuredImage.one(),
                    "url": photoEntry.url,
                    "title": photoEntry.title,
                    "caption": photoEntry.title,
                    "transform": 'square'
                  }
                } %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          {% include '_components/molecules/alert.twig' with {
            alert: {
              text: 'No photos match the current filters.',
              attrs: {
                role: 'alert',
                'aria-live': 'polite'
              }
            }
          } %}
        {% endif %}

        <div id="load-more-wrapper"
          {% if sprig.trigger == 'load-more-button' %}
            s-swap-oob="true"
          {% endif %}
          class="c-portfolio-grid__footer"
          x-data
        >
          {% if not isLastPage %}
            {% include '_components/atoms/button.twig' with {
              button: {
                text: 'Load More',
                tag: 'button',
                classes: 'o-button--arrow-down',
                attrs: {
                  id: 'load-more-button',
                  sprig: true,
                  's-val:offset': nextOffset,
                  's-val:limit': limit,
                  's-val:state': state,
                  's-select': '.c-photo-block-container, #load-more-wrapper',
                  's-target': '#photo-grid',
                  's-swap': 'beforeend',
                  ':s-val:sort': 'sort'
                }
                | merge(season|map(s => {('x-bind:s-val:season[]'): s|json_encode})|reduce((a, b) => a|merge(b), {}))
                | merge(genre|map(g => {('x-bind:s-val:genre[]'): g|json_encode})|reduce((a, b) => a|merge(b), {}))
              }
            } %}
          {% else %}
            <button id="load-more-button" style="display: none;"></button>
          {% endif %}
        </div>
      </div>{# end .c-portfolio__results #}

    </div>
  </div>

  
  
</div>

<script>
  function filterScroll() {
    return {
      saveScroll() {
        const el = document.querySelector('.c-filter-sections');
        if (el) sessionStorage.setItem('filterScrollTop', el.scrollTop);
      },
      restoreScroll() {
        const el = document.querySelector('.c-filter-sections');
        const top = sessionStorage.getItem('filterScrollTop');
        if (el && top !== null) {
          el.scrollTop = parseInt(top);
        }
      }
    }
  }
</script>
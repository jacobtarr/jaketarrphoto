{% macro renderImage(image, smallWidth, largeWidth, altText, transform = null, loading = true, imgClass = '') %}
  {% if image %}
    {% set isObject = image is iterable and image is not string %}

    {% if transform and isObject %}
      {# transform can be a handle (string) or an array #}
      {% set isHandle = transform is not iterable %}
      {% set base = isHandle ? { transform: transform } : transform %}

      {# URLs #}
      {% set jpegSrc = image.getUrl(base) %}
      {% set webpSrc = image.getUrl(base|merge({ format: 'webp' })) %}

      {# Dimensions for width/height attrs #}
      {% if isHandle %}
        {% set t = craft.app.imageTransforms.getTransformByHandle(transform) %}
        {% set imgWidth  = t.width  ?? largeWidth %}
        {% set imgHeight = t.height ?? ((image.getHeight() * (imgWidth / image.getWidth()))|round) %}
      {% else %}
        {% set imgWidth  = transform.width  ?? largeWidth %}
        {% set imgHeight = transform.height ?? ((image.getHeight() * (imgWidth / image.getWidth()))|round) %}
      {% endif %}

    {% elseif isObject %}
      {% set jpegSrc = image.getUrl({ width: largeWidth }) %}
      {% set webpSrc = image.getUrl({ width: largeWidth, format: 'webp' }) %}
      {% set imgWidth = largeWidth %}
      {% set imgHeight = (image.getHeight() * (largeWidth / image.getWidth()))|round %}

    {% else %}
      {# image was a string URL #}
      {% set jpegSrc = image|replace({ '.webp': '.jpg' }) %}
      {% set webpSrc = image %}
      {% set imgWidth = largeWidth %}
      {% set imgHeight = 'auto' %}
    {% endif %}

    <picture>
      <source srcset="{{ webpSrc }}" type="image/webp">
      <source srcset="{{ jpegSrc }}" type="image/jpeg">
      <img
        src="{{ jpegSrc }}"
        onload="this.classList.add('is-loaded')"
        {% if isObject and not transform %}
          srcset="{{ image.getUrl({ width: smallWidth }) }} {{ smallWidth }}w, {{ jpegSrc }} {{ largeWidth }}w"
        {% else %}
          srcset="{{ jpegSrc }} {{ imgWidth }}w"
        {% endif %}
        sizes="(max-width: 768px) 100vw, 50vw"
        alt="{{ altText }}"
        {% if loading %}loading="lazy"{% else %}fetchpriority="high"{% endif %}
        width="{{ imgWidth }}"
        height="{{ imgHeight }}"
        class="w-full h-full object-cover {{ imgClass|default('') }}"
      >
    </picture>
  {% endif %}
{% endmacro %}